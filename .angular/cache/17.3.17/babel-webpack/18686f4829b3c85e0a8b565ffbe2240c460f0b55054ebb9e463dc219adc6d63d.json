{"ast":null,"code":"import { BehaviorSubject, of } from 'rxjs';\nimport { catchError, tap, map } from 'rxjs/operators';\nimport { environment } from 'src/environments/environment';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../repositories/local/local-order.repository\";\nimport * as i2 from \"../repositories/firebase/firebase-order.repository\";\nimport * as i3 from \"./auth.service\";\nexport let OrderService = /*#__PURE__*/(() => {\n  class OrderService {\n    constructor(localRepo, firebaseRepo, authService) {\n      this.localRepo = localRepo;\n      this.firebaseRepo = firebaseRepo;\n      this.authService = authService;\n      this.ordersSubject = new BehaviorSubject([]);\n      this.orders$ = this.ordersSubject.asObservable();\n      this.pendingCount$ = this.orders$.pipe(map(orders => orders.filter(o => o.status === 'pending').length));\n      // Inicializar con los pedidos del usuario actual\n      this.authService.currentUser$.subscribe(user => {\n        if (user) {\n          this.loadInitialOrders(user.uid);\n        } else {\n          this.ordersSubject.next([]);\n        }\n      });\n    }\n    loadInitialOrders(userId) {\n      this.localRepo.getOrders(userId).subscribe(orders => {\n        this.ordersSubject.next(orders);\n      });\n    }\n    createOrder(order) {\n      // 1. Siempre guardar en local primero (Offline First)\n      order.status = 'pending';\n      return this.localRepo.createOrder(order).pipe(tap(savedOrder => {\n        // Actualizar el subject local\n        const currentOrders = this.ordersSubject.value;\n        this.ordersSubject.next([savedOrder, ...currentOrders]);\n        if (environment.useFirebase) {\n          this.firebaseRepo.createOrder(savedOrder).pipe(tap(() => {\n            this.localRepo.updateStatus(savedOrder.id, 'synced');\n            // Actualizar status en el subject\n            const updatedOrders = this.ordersSubject.value.map(o => o.id === savedOrder.id ? {\n              ...o,\n              status: 'synced'\n            } : o);\n            this.ordersSubject.next(updatedOrders);\n          }), catchError(err => {\n            console.warn('Sync failed, keeping local order', err);\n            return of(savedOrder);\n          })).subscribe();\n        }\n      }));\n    }\n    getOrders(userId) {\n      return this.orders$;\n    }\n    static {\n      this.ɵfac = function OrderService_Factory(t) {\n        return new (t || OrderService)(i0.ɵɵinject(i1.LocalOrderRepository), i0.ɵɵinject(i2.FirebaseOrderRepository), i0.ɵɵinject(i3.AuthService));\n      };\n    }\n    static {\n      this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n        token: OrderService,\n        factory: OrderService.ɵfac,\n        providedIn: 'root'\n      });\n    }\n  }\n  return OrderService;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}